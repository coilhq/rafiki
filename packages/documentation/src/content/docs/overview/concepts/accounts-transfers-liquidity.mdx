---
title: Accounts, transfers, and liquidity
---

import { LinkOut } from '@interledger/docs-design-system'

import { CodeBlock } from '@interledger/docs-design-system'

## Accounts

Rafiki uses a combination of liquidity (credit) and settlement (debit) accounts to perform <LinkOut href="https://en.wikipedia.org/wiki/Double-entry_bookkeeping">double-entry accounting</LinkOut>.

In this context, accounts in Rafiki are specifically the accounts that peers hold with one another. These are not customer accounts or accounts on any underlying ledgers. This distinction is crucial for understanding how Rafiki handles transactions and settlements.

### Liquidity accounts

A liquidity account holds a non-negative balance, with Rafiki ensuring that total debits do not exceed total credits.

There is one liquidity account for each of the following resources:

- Asset
- Peer
- Wallet address (for SPSP/Web Monetization receiving)
- Incoming payment
- Outgoing payment

### Settlement accounts

A settlement account holds a non-positive balance, with Rafiki ensuring that total credits do not exceed total debits. A settlement account represents the total funds an Account Servicing Entity has deposited into Rafiki.

There is one settlement account for each asset.

## Assets

An asset in Rafiki represents an item of value that can be transferred via the Interledger Protocol. Since the Interledger Protocol aims to create an internet of value, it allows for the transfer of any asset, not just currency. In practice, however, assets are usually denominated in a currency (fiat or branded currencies).

Before peering with another account servicing entity, you must agree on the asset you will use for settlement. The Interledger packets exchanged between you and your peer will be denominated in the agreed-upon asset.

Furthermore, an account servicing entity performing currency exchange must provide asset liquidity. Asset liquidity ensures there is enough value available to handle transactions in the specified assets.

Assets are managed via the [Backend Admin API](/integration/services/backend-service#graphql-backend-admin-api) or the [Rafiki Admin application](/admin/admin-user-guide/). Wallet addresses are created for existing assets and are tied to those assets.

### The asset type

The `asset` type in Rafiki consists of a value, an asset code, and an asset scale.

| **Property** | **Type** | **Description**                                                                                                      | **Example** |
| ------------ | -------- | -------------------------------------------------------------------------------------------------------------------- | ----------- |
| `value`      | BigInt   | Numerical amount                                                                                                     | 10000       |
| `assetCode`  | String   | Should be an <LinkOut href="https://en.wikipedia.org/wiki/ISO_4217">ISO 4217 currency code</LinkOut> where available | “USD”       |
| `assetScale` | Integer  | Difference in order of magnitude between the standard unit and a fractional unit                                     | 2           |

To convert from an asset to a currency amount that is more human-readable, apply the following formula:

$currencyAmount = \frac{value}{10^{assetScale}}$

Using the example from the table above, our formula looks like this:

$\frac{10000}{10^2} =100.00$ USD

## Transfers

Transfers in Rafiki are based on double-entry accounting, increasing both the total debits of one account and the total credits of another by the same amount. Deposits and withdrawals are both types of transfers.

### Single-phase transfer

A single-phase transfer posts funds to accounts immediately when they are created.

### Two-phase transfer

A two-phase transfer moves funds in stages.

1. Reserve funds (`pending`)
2. Resolve funds (`post`, `void`, or `expire`)

The name _two-phase transfer_ is a reference to the <LinkOut href="https://en.wikipedia.org/wiki/Two-phase_commit_protocol">two-phase commit protocol</LinkOut> for distributed transactions.

## Liquidity

Rafiki tracks liquidity using the Interledger Protocol, which is a clearing protocol, without physically holding funds.

### Types of liquidity

#### Asset liquidity

Asset liquidity represents the value, denominated in a given asset, that Rafiki has at its disposal in which to send or forward ILP packets. Asset liquidity increases when packets are received and decreases when packets are sent. Asset liquidity is always positive and cannot fall below zero.

You should define and adjust asset liquidity based on your liquidity risk profile.

#### Peer liquidity

Peer liquidity is the credit line, denominated in the asset of the peering relationship, Rafiki extends to a peer. Peer liquidity should be defined in the peering agreement and depends on the trust between the transacting peers. If peer liquidity is insufficient, payments will not be processed. When peer liquidity is used up, you and your peer should settle then reset your peer liquidity.

:::note
A peering agreement is a legal contract between the parties involved in a peering relationship. It defines terms such as the assets involved, auth tokens, connection endpoints, and other operational details. It is not configured or managed within Rafiki but is necessary for establishing the terms under which assets are exchanged between peers.
:::

#### Payment liquidity

Payment liquidity is managed for incoming and outgoing payments created via Open Payments through liquidity accounts in your accounting database. When incoming or outgoing payments are created via the Open Payments APIs, a corresponding liquidity account is automatically created. Liquidity must be deposited to an outgoing payment account before the payment can be processed. You are notified to deposit or withdraw liquidity via webhook events.

## TigerBeetle

TigerBeetle is a high-performance distributed financial accounting database used by Rafiki’s `backend` service to store account balance data at the ILP layer. Both liquidity and settlement accounts in Rafiki correspond to TigerBeetle credit and debit accounts, respectively. TigerBeetle only holds balance data without any additional ILP packet metadata. For detailed information on TigerBeetle, including its consensus mechanism and its limitations, visit the official TigerBeetle <LinkOut href="https://docs.tigerbeetle.com/">documentation</LinkOut> and <LinkOut href="https://tigerbeetle.com/blog/">blog</LinkOut>.

You have the flexibility to choose whether to use TigerBeetle or opt for a separate Postgres database. However, TigerBeetle is recommended due to its speed, efficiency, and dedicated design for handling double ledger accounting. For more information about Tigerbeetle in a production environment, see [Running Rafiki in production](/integration/prod/helm-k8s/#tigerbeetle).
