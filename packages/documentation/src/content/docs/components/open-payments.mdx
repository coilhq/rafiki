---
title: Open Payments
---

Open Payments is an API standard that allows third-parties/clients to initiate payments and to view the transaction history on the account holder's account (with the account holder's consent). Extensive documentation can be found on the [Open Payments website](https://openpayments.guide).

Rafiki implements the Open Payments APIs. Every request and response is validated against the [Open Payments API specification](https://github.com/interledger/open-payments/tree/main/openapi).

To update the API specification, create a Pull Request on the [Open Payments GitHub Repository](https://github.com/interledger/open-payments/). Changes will automatically be pushed to [Readme](https://readme.com/), which hosts the [API reference](https://docs.openpayments.guide/reference/) on the [Open Payments website](https://openpayments.guide).

## Key Registry

### Sequence Diagram

![Key registry diagram](/img/key-registry-diagram.png)

### Basics

#### What is the key registry?

A key registry is a list of keys stored by a client that requires access to Open Payments resources protected by an authorization server (AS). A key is generated and added to the registry by a client and the client is represented by a [wallet address](/reference/glossary#wallet-address). The wallet address's associated key registry is exposed publically at the path `WALLET_ADDRESS/jwks.json` in anticipation of a grant request on an AS.

#### What is the purpose of the key registry?

The key registry allows an AS to verify that a client is who they say they are. Because a grant request is completed over multiple signed HTTP requests it is thus important for a client to provide a way to consistently identify itself across these requests to the AS.

#### How is this achieved?

The client will generate an asymmetric key pair, which should include a key id identifying them. When the client makes a grant request, it should include a signature in the header signed by the private key and a `Signature-Input` header that, among other things, should include the key id of the public key associated with the private key used to sign the signature.

When the AS receives a signed grant request, it first acquires the key registry exposed by the client by making a `GET` request on its `/jwks.json` endpoint. The domain of the client is acquired by the AS during the initial grant request, after which the AS binds it to the grant and uses it to acquire the key registry for susequent grant requests.

Once the AS has acquired the client's key registry, it searches for the public key with a key id that matches the one included in the `Signature-Input` header. Once it finds it, the public key will be used to decrypt and verify the signature. Then the AS will proceed with the grant request.

### JWK

#### Key Structure

A key registry should expose public keys in the form of a JWK. They should be generated using the `ed25519` algorithm, and the resultant JWK should have fields with the following values:

```json
// Key should also have a `kid` field to identify it in a signature
// Public keys should contain the `x` field
{
  "alg": "EdDSA",
  "kty": "OKP",
  "crv": "Ed25519"
}
```

The private key should be used to sign the payload described in the httpsig signature method.

### Signature

#### Signature Method

The signature is formatted and verified using the [httpbis-message-signature](https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-message-signatures-16) method.

In general, a request secured with the `httpsig` method contains two headers, the `Signature` and the `Signature-Input`. The `Signature` is data signed by the algorithm specified in the JWK, and the signature input is a comma-separated list of headers that map to values in the data that was signed. These values should match the values provided in the headers of a signed GNAP request.

#### Signature Base

The components of the signature base correspond to components of the HTTP request that it is supposed to sign, as described in the [GNAP core protocol](https://datatracker.ietf.org/doc/html/draft-ietf-gnap-core-protocol#section-7.3.1).

The following components must be included:

- **@method**: The method used in the HTTP request.
- **@target-uri**: The full request URI of the HTTP request.

If the request has a body:

- **content-digest**: The Content-Digest header of the request. It should contain

If the request has an authorization header:

- **authorization**: The authorization header used to present an access token.

- **@signature-params**: A list of the metadata in the signature base, comprised primarily of a space-separated list of quote-enclosed component names further grouped in parentheses, a timestamp for when it was created, and the keyid of the key that signed it.
  **NOTE:** `@signature-params` MUST be the last component listed in the signature base.

Each component should be on a separate line. The component name should be in quotes, followed by a colon, then a space, then the value of the component.

##### Signature Base Example

```http
"@method": POST
"@target-uri": https://server.example.com/gnap
"content-digest": \
  sha-256=:q2XBmzRDCREcS2nWo/6LYwYyjrlN1bRfv+HKLbeGAGg=:
"content-length": 988
"content-type": application/json
"@signature-params": ("@method" "@target-uri" "content-digest" \
  "content-length" "content-type");created=1618884473\
  ;keyid="gnap-rsa"
```

#### Signature Input Example

```http
Signature-Input: sig1=("@method" "@target-uri" "content-digest" \
  "content-length" "content-type");created=1618884473\
  ;keyid="gnap-rsa";nonce="NAOEJF12ER2";tag="gnap"
```

## Grant Interaction Flow

import { LargeImg } from '@interledger/docs-design-system'

### Sequence Diagram

<LargeImg src='/img/grant-interaction-flow.svg' alt='Sequence diagram' />

### Endpoints

If the AS deems interaction necessary to issue a grant, there are five main endpoints that are used once a pending grant has been created. In each endpoint, the specific interaction is identified with an interaction id and an interaction nonce. Both of these are provided in the query parameters of the URL when the authorization server redirects to the Identity Provider. The endpoints, in order of their calling, are as follows:

- `GET /interact/:id/:nonce` (made by the client to the AS, establishes an interaction session, redirects browser session to IDP consent screen)
- `GET /grant/:id/:nonce` (made by the IDP to the AS, secured with `x-idp-secret` header, returns grant info for the consent screen to enumerate )
  - **This is served on INTERACTION_PORT and its default value is 3009**
- `POST /grant/:id/:nonce/(accept OR reject)` (made by the IDP to the AS, secured with `x-idp-secret` header, accepts or rejects the grant based on the user's input on the consent screen. **IDP then redirects to `GET /interact/:id/:nonce/finish`**)
  - **This is served on INTERACTION_PORT and its default value is 3009**
- `GET /interact/:id/:nonce/finish` (ends the interaction established by `GET /interact/:id/:nonce`, redirects browser session to client callback. Contains a query param that either indicates a failure, or on success, a `hash` parameter that the client can use to verify the successful interaction, and the `interact_ref` that identifies the interaction on the AS.)
  - Examples include: - `?result=grant_rejected` (if interaction was rejected) - `?result=grant_invalid` (if grant is not in a state where it may be accepted or rejected, e.g. already approved) - `?hash=p28jsq0Y2KK3WS__a42tavNC64ldGTBroywsWxT4md_jZQ1R\HZT8BOWYHcLmObM7XHPAdJzTZMtKBsaraJ64A
&interact_ref=4IFWWIKYBC2PQ6U56NL1` (if interaction was accepted) - `hash` is a `sha-256` hash of values provided by the client in the body of the [grant initialization request](https://docs.openpayments.guide/reference/post-request) (`interact.finish.nonce`), values returned in the AS response for that request (`interact.finish`), the `interact_ref` provided alongside the `hash`, and the uri of the grant initialization request (`https://auth-server.com/`).
- `POST /continue/:id` ([this should still be accurate](https://docs.openpayments.guide/reference/post-continue), final back-channel request made by client if interaction was successful, AS responds with an access token)

#### On `x-idp-secret`

`x-idp-secret` is the name of a header that is used for `GET /grant/:id/:nonce`, `POST /grant/:id/:nonce/accept`, and `POST /grant/:id/:nonce/reject` requests. Its purpose is to secure communications between the IDP and the AS and its value should be a shared secret known to both entities.

To set this up, set the `IDENTITY_SERVER_SECRET` on the AS environment to a value that is also used to configure the IDP's requests to the AS.
