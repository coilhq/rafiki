---
title: Accounts, transfers, and Liquidity
---

## Asset

As per the [Mariam Webster Dictionary](https://www.merriam-webster.com/dictionary/asset), an Asset is "an item of value owned". Since the Interledger Protocol aims to create an internet of value, it allows for the transfer of any asset, not just currency. In reality, however, mainly assets denominated in a currency, i.e. fiat, commodity, or alternative currencies like crypto and branded currencies, are transferred via the Interledger Protocol.

### The `Asset` type

The `Asset` type in Rafiki is comprised of a value, an asset code, and an asset scale.

| Property   | Type    | Example |
| ---------- | ------- | ------- |
| value      | BigInt  | `10000` |
| assetCode  | String  | `"USD"` |
| assetScale | Integer | `2`     |

The asset code SHOULD be an [ISO 4217 currency code](https://en.wikipedia.org/wiki/ISO_4217), if it is available for the asset. The asset scale is the difference in orders of magnitude between the standard unit and a corresponding fractional unit. To convert from `Asset` to a currency amount that is more common to humans, apply the following formula:

$currencyAmount = \frac{value}{10^{assetScale}}$

Hence, the above example represents $\frac{10000}{10^2} =100.00$ USD.

Assets are represented in the `Asset` type due to JavaScript/Typescript's deficiencies when handling floats.

### Assets in Rafiki

When two Account Servicing Entities peer their Rafiki instances, they need to define the asset(s) they are going to settle in. The Interledger packets they are going to exchange will then also be denominated in that asset.

Furthermore, if an Account Servicing Entity is performing currency exchange, they need to provide [asset liquidity](/concepts/accounting/liquidity#asset-liquidity).

Assets can be created and managed via the Admin GraphQL API directly or via the Rafiki Admin dashboard. Currently, [wallet addresses](/reference/glossary#wallet-address) can only be created for an existing asset and are tied to that asset.

## Accounts

Rafiki uses a combination of liquidity and settlement accounts to perform [double-entry accounting](https://en.wikipedia.org/wiki/Double-entry_bookkeeping).

### Liquidity account

A liquidity account may only hold a positive balance. Rafiki enforces that its total debits MUST NOT exceed its total credits amount.

There is one liquidity account for each of the following resource:

- [Asset](/reference/glossary#asset)
- [Peer](/reference/glossary#peer)
- Wallet Address (for [SPSP](/reference/glossary#simple-payments-setup-protocol-spsp) / [Web Monetization](/reference/glossary#web-monetization) receiving)
- Incoming Payment
- Outgoing Payment

Asset and Peer liquidity accounts are created when calling `createAsset` and `createPeer` [GraphQL Admin API mutations](/apis/backend/mutations) respectively, while liquidity accounts for wallet addresses, incoming and outgoing payments are created on-the-fly during payment processing or web monetization events.

Any liquidity management is done by the [Account Servicing Entity](/reference/glossary#account-servicing-entity) through the GraphQL Admin API. See [webhook events](/integration/webhook-events) and [liquidity documentation](/concepts/accounting/liquidity) for more information.

### Settlement account

A settlement account may only hold a negative balance. Rafiki enforces that its total credits MUST NOT exceed its total debits amount. A settlement account represents those total amount of funds an [Account Servicing Entity](/reference/glossary#account-servicing-entity) has deposited into Rafiki.

There is one settlement account for each asset.

## Transfers

Rafiki transfers perform double-entry accounting. Every transfer increases both the total debits of one account and the total credits of a second account by the same amount.

### Intra-Rafiki

Consider the following accounts referenced throughout the below documentation:

- **USD Settlement Acc.** - USD asset settlement account (always zero or negative balance)
- **USD (Asset) Liquidity Acc.** - USD settlement account (always zero or positive balance)
- **Peer Liquidity Acc.** - USD asset counterparty liquidity account (always zero or positive balance)
- **Wallet Address Liquidity Acc.** - USD wallet address liquidity account (always zero or positive balance)
- **Incoming Payment Liquidity Acc.** - USD incoming payment liquidity account (always zero or positive balance)
- **Outgoing Payment Liquidity Acc.** - USD outgoing payment liquidity account (always zero or positive balance)

#### Deposits

Action of debiting the settlement account, and crediting the liquidity account.

##### Depositing Asset Liquidity

| Debit Account | Credit Account  |
| ------------- | --------------- |
| Settlement    | Asset Liquidity |

- Example: depositing `100 USD`

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>USD Settlement Acc. </th>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>100</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>100</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Depositing Peer Liquidity

| Debit Account | Credit Account |
| ------------- | -------------- |
| Settlement    | Peer Liquidity |

- Example: peering relationship in USD, depositing `100 USD`

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>USD Settlement Acc. </th>
    <th style='text-align: left'>Peer Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>100</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>100</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Depositing Outgoing Payment Liquidity

| Debit Account | Credit Account   |
| ------------- | ---------------- |
| Settlement    | Outgoing Payment |

- Example: depositing `35 USD`

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>USD Settlement Acc. </th>
    <th style='text-align: left'>Outgoing Payment Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>35</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>35</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

#### Withdrawals

Action of debiting the liquidity account, and crediting the settlement account.

##### Withdrawing Asset Liquidity

| Debit Account   | Credit Account |
| --------------- | -------------- |
| Asset Liquidity | Settlement     |

- Example: withdrawing `50 USD`

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
    <th style='text-align: left'>USD Settlement Acc. </th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>50</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>50</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Withdrawing Peer Liquidity

| Debit Account  | Credit Account |
| -------------- | -------------- |
| Peer Liquidity | Settlement     |

- Example: peering relationship in USD, withdrawing `50 USD`

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Peer Liquidity Acc.</th>
    <th style='text-align: left'>USD Settlement Acc. </th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>50</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>50</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Withdrawing Wallet Address Liquidity (example: 2 USD)

| Debit Account  | Credit Account |
| -------------- | -------------- |
| Wallet Address | Settlement     |

- Example: withdrawing `2 USD`

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Wallet Address Liquidity Acc.</th>
    <th style='text-align: left'>USD Settlement Acc. </th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>2</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>2</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Withdrawing Incoming Payment Liquidity

| Debit Account    | Credit Account |
| ---------------- | -------------- |
| Incoming Payment | Settlement     |

- Example: withdrawing `25 USD`

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Incoming Payment Liquidity Acc.</th>
    <th style='text-align: left'>USD Settlement Acc. </th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>25</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>25</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Withdrawing Outgoing Payment Liquidity

| Debit Account    | Credit Account |
| ---------------- | -------------- |
| Outgoing Payment | Settlement     |

- Example: withdrawing `1 USD`

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Outgoing Payment Liquidity Acc.</th>
    <th style='text-align: left'>USD Settlement Acc. </th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>1</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>1</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

#### Payments (Same Asset)

##### Simple Payment Setup Protocol (SPSP) / Web Monetization

| Debit Account    | Credit Account |
| ---------------- | -------------- |
| Outgoing Payment | Wallet Address |

- Example: Send a Web Monetization Payment of `2 USD` over SPSP to a wallet address. Sender and receiver have wallet addresses at the same Rafiki.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Outgoing Payment Liquidity Acc.</th>
    <th style='text-align: left'>Wallet Address Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>2</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>2</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Send Amount < Receive Amount

| Debit Account    | Credit Account   |
| ---------------- | ---------------- |
| Outgoing Payment | Incoming Payment |
| Asset Liquidity  | Incoming Payment |

- Example: Sender consented to a payment of `14 USD` but quote promised to deliver `15 USD`.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Outgoing Payment Liquidity Acc.</th>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
    <th style='text-align: left'>Incoming Payment Liquidity Acc. </th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>14</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>1</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>15</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Send Amount > Receive Amount

| Debit Account    | Credit Account   |
| ---------------- | ---------------- |
| Outgoing Payment | Incoming Payment |
| Outgoing Payment | Asset Liquidity  |

- Example: Sender consented to a payment of `15 USD` but quote promised to deliver `14 USD`.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Outgoing Payment Liquidity Acc.</th>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
    <th style='text-align: left'>Incoming Payment Liquidity Acc. </th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>15</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>1</td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>14</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

#### Payments (Cross Currency)

| Debit Account    | Credit Account   | Asset |
| ---------------- | ---------------- | ----- |
| Outgoing Payment | Asset Liquidity  | `ABC` |
| Asset Liquidity  | Incoming Payment | `XYZ` |

- Example: Outgoing payment for `10 USD`, incoming payment receives `9 EUR`.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Outgoing Payment Liquidity Acc.</th>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>10</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>10</td>
        </tr>
      </table>
    </td>
  </tr>
  <tr class='header-row'>
    <th style='text-align: left'>EUR (Asset) Liquidity Acc.</th>
    <th style='text-align: left'>Incoming Payment Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>9</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>9</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### SPSP / Web Monetization

| Debit Account    | Credit Account  | Asset |
| ---------------- | --------------- | ----- |
| Outgoing Payment | Asset Liquidity | `ABC` |
| Asset Liquidity  | Wallet Address  | `XYZ` |

- Example: Outgoing payment for `2 USD`, wallet address receives `1 EUR`.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Outgoing Payment Liquidity Acc.</th>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>2</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>2</td>
        </tr>
      </table>
    </td>
  </tr>
  <tr class='header-row'>
    <th style='text-align: left'>EUR (Asset) Liquidity Acc.</th>
    <th style='text-align: left'>Wallet Address Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>1</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>1</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

### Interledger

Sender and receiver do not have wallet addresses at the same Rafiki instance.

#### Sending Connector

##### Same asset

| Debit Account    | Credit Account |
| ---------------- | -------------- |
| Outgoing Payment | Peer Liquidity |

- Example: Sender creates an outgoing payment for `100 USD` to an incoming payment at a peer's Rafiki instance. The peering relationship is in USD.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Outgoing Payment Liquidity Acc.</th>
    <th style='text-align: left'>Peer Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>100</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>100</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Cross currency

| Debit Account    | Credit Account  | Asset |
| ---------------- | --------------- | ----- |
| Outgoing Payment | Asset Liquidity | ABC   |
| Asset Liquidity  | Peer Liquidity  | XYZ   |

- Example: Sender creates an outgoing payment for 100 USD to an incoming payment at a peer's Rafiki instance. The peering relationship is in EUR, so payment is converted on the sending side.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Outgoing Payment Liquidity Acc.</th>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>100</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>100</td>
        </tr>
      </table>
    </td>
  </tr>
  <tr class='header-row'>
    <th style='text-align: left'>EUR (Asset) Liquidity Acc.</th>
    <th style='text-align: left'>Peer Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>90</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>90</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

#### Receiving Connector

##### Same asset

| Debit Account  | Credit Account   |
| -------------- | ---------------- |
| Peer Liquidity | Incoming Payment |

- Example: An incoming payment receives `100 USD` from an outgoing payment at a peer's Rafiki instance.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Peer Liquidity Acc.</th>
    <th style='text-align: left'>Incoming Payment Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>100</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>100</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

###### SPSP / Web Monetization

| Debit Account  | Credit Account |
| -------------- | -------------- |
| Peer Liquidity | Wallet Address |

- Example: A wallet address receives `2 USD` from an ILP payment at a peer's Rafiki instance.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Peer Liquidity Acc.</th>
    <th style='text-align: left'>Wallet Address Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>2</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>2</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Cross currency

| Debit Account   | Credit Account   | Asset |
| --------------- | ---------------- | ----- |
| Peer Liquidity  | Asset Liquidity  | `ABC` |
| Asset Liquidity | Incoming Payment | `XYZ` |

- Example: A Rafiki instance receives `10 USD` from a peer (peering relationship in USD) to be deposited in an incoming payment liquidity account denominated in EUR. The payment is converted to EUR and deposited.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Peer Liquidity Acc.</th>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>10</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>10</td>
        </tr>
      </table>
    </td>
  </tr>
  <tr class='header-row'>
    <th style='text-align: left'>EUR (Asset) Liquidity Acc.</th>
    <th style='text-align: left'>Incoming Payment Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>9</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>9</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

###### SPSP / Web Monetization

| Debit Account   | Credit Account  | Asset |
| --------------- | --------------- | ----- |
| Peer Liquidity  | Asset Liquidity | `ABC` |
| Asset Liquidity | Wallet Address  | `XYZ` |

- Example: A Rafiki instance receives `10 USD` from a peer (peering relationship in USD) to be deposited in a wallet address liquidity account denominated in EUR. The payment is converted to EUR and deposited.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Peer Liquidity Acc.</th>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>2</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>2</td>
        </tr>
      </table>
    </td>
  </tr>
  <tr class='header-row'>
    <th style='text-align: left'>EUR (Asset) Liquidity Acc.</th>
    <th style='text-align: left'>Wallet Address Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>1</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>1</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

#### Connector

##### Same asset

| Debit Account  | Credit Account |
| -------------- | -------------- |
| Peer Liquidity | Peer Liquidity |

- Example: Rafiki forwards `10 USD` from peer A to peer B.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Peer A Liquidity Acc.</th>
    <th style='text-align: left'>Peer B Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>10</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>10</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

##### Cross currency

| Debit Account   | Credit Account  | Asset |
| --------------- | --------------- | ----- |
| Peer Liquidity  | Asset Liquidity | `ABC` |
| Asset Liquidity | Peer Liquidity  | `XYZ` |

- Example: Rafiki receives `100 USD` from peer A and forwards 90 EUR to peer B.

<table class='accounting-table not-content'>
  <tr class='header-row'>
    <th style='text-align: left'>Peer A Liquidity Acc.</th>
    <th style='text-align: left'>USD (Asset) Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>100</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>100</td>
        </tr>
      </table>
    </td>
  </tr>
  <tr class='header-row'>
    <th style='text-align: left'>EUR (Asset) Liquidity Acc.</th>
    <th style='text-align: left'>Peer B Liquidity Acc.</th>
  </tr>
  <tr>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td>90</td>
          <td></td>
        </tr>
      </table>
    </td>
    <td>
      <table>
        <tr>
          <th>Debit</th>
          <th>Credit</th>
        </tr>
        <tr>
          <td></td>
          <td>90</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

## Liquidity

Rafiki implements a clearing protocol - the [Interledger Protocol](/reference/glossary#interledger-protocol). As such, it does not hold liquidity but keeps track of liquidity moving through it.

### Types of Liquidity

#### Asset Liquidity

Asset Liquidity defines the amount of value, denominated in a given asset, Rafiki has at its disposal to send or forward ILP packets in. It increases if packets denominated in a given asset are received and decreases if packets denominated in a given asset are sent. It is always positive and cannot fall below 0.

Account Servicing Entities should define and adjust the asset liquidity based on their liquidity risk profile.

##### Example

Rafiki has been configured with 2 assets, EUR and USD, both with an asset scale of 0. The EUR liquidity is 10, the USD liquidity if 50.

In a cross-currency transaction, Rafiki receives packets worth 10 EUR and sends packets worth 11 USD. The EUR liquidity is increased to 20, the USD liquidity is reduced to 39.

A transaction where Rafiki receives 50 EUR and would have to sent 55 USD would fail because Rafiki does not have enough USD liquidity.

#### Peer Liquidity

Peer Liquidity defines the line of credit, denominated in the asset of the peering relationship, that Rafiki gives a certain peer. It should be defined in the peering agreement and depends on the trust between the transacting peers. If peer liquidity is not sufficient, payments will not be processed. Once the peer liquidity is used up, peers should settle and then reset their peer liquidity.

##### Example

A configured peer _Cloud Nine Wallet_ within Rafiki has a peer liquidity of 100 USD. Rafiki can send packets up to 100 USD to wallet addresses issued by _Cloud Nine Wallet_. Once that liquidity is used up, we should settle with _Cloud Nine Wallet_ and then reset their liquidity to 100 USD.

#### Payment Liquidity

When Open Payments incoming or outgoing payments are created, a liquidity account is created within the accounting database. Liquidity needs to be deposited to an outgoing payment before the payment can be processed. The Account Servicing Entity is notified to deposit liquidity via the `outgoing_payment.created` event. Similarly, packets that are received for an incoming payment increase its liquidity. The Account Servicing Entity is notified to withdraw that liquidity via the `incoming_payment.completed` event.

### Depositing and Withdrawing Liquidity

> **Note:** The `idempotencyKey` must be provided whenever calling mutations dealing with liquidity.
> This key allows safely retrying requests, without performing the operation multiple times.
> This should be a unique key (typically, a V4 UUID). For more information on Rafiki's idempotency, [see more](/apis/idempotency).

#### Asset Liquidity

Deposit and withdraw asset liquidity via the Admin API (or UI):

```graphql
mutation DepositAssetLiquidity($input: DepositAssetLiquidityInput!) {
  depositAssetLiquidity(input: $input) {
    code
    success
    message
    error
  }
}
```

where

```json
{
  "input": {
    "id": "b97fd85a-126e-42ef-b40d-1a50a70ffa6f",
    "assetId": "7b8b0f65-896d-4403-b7ba-2e24bf20eb35",
    "amount": "100",
    "idempotencyKey": "b97fd85a-126e-42ef-b40d-1a50a70ffa6f"
  }
}
```

and

```graphql
mutation CreateAssetLiquidityWithdrawal(
  $input: CreateAssetLiquidityWithdrawalInput!
) {
  createAssetLiquidityWithdrawal(input: $input) {
    code
    success
    message
    error
  }
}
```

where

```json
{
  "input": {
    "id": "b97fd85a-126e-42ef-b40d-1a50a70ffa6f",
    "assetId": "7b8b0f65-896d-4403-b7ba-2e24bf20eb35",
    "amount": "100",
    "idempotencyKey": "b97fd85a-126e-42ef-b40d-1a50a70ffa6f",
    "timeoutSeconds": 0
  }
}
```

See `PostLiquidityWithdrawal` and `VoidLiquidityWithdrawal` at the [below](#postliquiditywithdrawal-or-voidliquiditywithdrawal) section.

#### Peer Liquidity

Deposit and withdraw peer liquidity via the Admin API (or UI):

```graphql
mutation DepositPeerLiquidity($input: DepositPeerLiquidityInput!) {
  depositPeerLiquidity(input: $input) {
    code
    success
    message
    error
  }
}
```

where

```json
{
  "input": {
    "id": "a09b730d-8610-4fda-98fa-ec7acb19c775",
    "peerId": "73158598-2e0c-4973-895e-aebd115af260",
    "amount": "1000000",
    "idempotencyKey": "a09b730d-8610-4fda-98fa-ec7acb19c775",
    "timeoutSeconds": 0
  }
}
```

and

```graphql
mutation CreatePeerLiquidityWithdrawal(
  $input: CreatePeerLiquidityWithdrawalInput!
) {
  createPeerLiquidityWithdrawal(input: $input) {
    code
    success
    message
    error
  }
}
```

where

```json
{
  "input": {
    "id": "421fae87-9a59-4217-9ff8-faf55ffab9c6",
    "peerId": "73158598-2e0c-4973-895e-aebd115af260",
    "amount": "100",
    "timeoutSeconds": 0
  }
}
```

See `PostLiquidityWithdrawal` and `VoidLiquidityWithdrawal` at the [below](#postliquiditywithdrawal-or-voidliquiditywithdrawal) section.

#### Payment Liquidity

##### Outgoing payment

Deposit and withdraw outgoing payment liquidity via the Admin API only:

```graphql
mutation DepositOutgoingPaymentLiquidity(
  $input: DepositOutgoingPaymentLiquidityInput!
) {
  depositOutgoingPaymentLiquidity(input: $input) {
    code
    error
    message
    success
  }
}
```

where

```json
{
  "input": {
    "outgoingPaymentId": "b4f85d5c-652d-472d-873c-4ba2a5e39052",
    "idempotencyKey": "a09b730d-8610-4fda-98fa-ec7acb19c775"
  }
}
```

and

```graphql
mutation CreateOutgoingPaymentWithdrawal(
  $input: CreateOutgoingPaymentWithdrawalInput!
) {
  createOutgoingPaymentWithdrawal(input: $input) {
    code
    error
    message
    success
  }
}
```

where

```json
{
  "input": {
    "outgoingPaymentId": "b4f85d5c-652d-472d-873c-4ba2a5e39052",
    "idempotencyKey": "a09b730d-8610-4fda-98fa-ec7acb19c775",
    "timeoutSeconds": 0
  }
}
```

See `PostLiquidityWithdrawal` and `VoidLiquidityWithdrawal` at the [below](#postliquiditywithdrawal-or-voidliquiditywithdrawal) section.

##### Incoming payment

Withdraw incoming payment liquidity via the Admin API only:

```graphql
mutation CreateIncomingPaymentWithdrawal(
  $input: CreateIncomingPaymentWithdrawalInput!
) {
  createIncomingPaymentWithdrawal(input: $input) {
    code
    error
    message
    success
  }
}
```

where

```json
{
  "input": {
    "incomingPaymentId": "b4f85d5c-652d-472d-873c-4ba2a5e39052",
    "idempotencyKey": "a09b730d-8610-4fda-98fa-ec7acb19c775",
    "timeoutSeconds": 0
  }
}
```

See `PostLiquidityWithdrawal` and `VoidLiquidityWithdrawal` at the [below](#postliquiditywithdrawal-or-voidliquiditywithdrawal) section.

### `PostLiquidityWithdrawal` or `VoidLiquidityWithdrawal`

`PostLiquidityWithdrawal` and `VoidLiquidityWithdrawal` are only applicable for two-phase withdrawals.

- `PostLiquidityWithdrawal` - Post liquidity withdrawal. Withdrawals with `> 0` timeouts are two-phase transfers and are committed via this mutation.
- `VoidLiquidityWithdrawal` - Void liquidity withdrawal. Withdrawals with `> 0` timeouts are two-phase transfers and are rolled back via this mutation.

When a withdrawal liquidity transaction is requested with a non-zero `timeout` value _(Zero denotes absence of timeout)_,
the transfer will be created as a two-phase transfer [see more](https://en.wikipedia.org/wiki/Two-phase_commit_protocol)

If the timeout interval passes before the transfer is either posted or voided, the transfer expires and the full amount is returned to the original account.
Note that timeouts are given as intervals, specified in seconds, rather than as absolute timestamps.

The following withdrawal payments support two-phase transfers:

- Asset Liquidity Withdrawal
- Wallet Address Withdrawal
- Peer Liquidity Withdrawal
- Incoming Payment Withdrawal
- Outgoing Payment Withdrawal

#### PostLiquidityWithdrawal

```graphql
mutation PostLiquidityWithdrawal($input: PostLiquidityWithdrawalInput!) {
  postLiquidityWithdrawal(input: $input) {
    code
    error
    message
    success
  }
}
```

where

```json
{
  "input": {
    "withdrawalId": "b4f85d5c-652d-472d-873c-4ba2a5e39052",
    "idempotencyKey": "a09b730d-8610-4fda-98fa-ec7acb19c775"
  }
}
```

#### VoidLiquidityWithdrawal

```graphql
mutation VoidLiquidityWithdrawal($input: VoidLiquidityWithdrawalInput!) {
  voidLiquidityWithdrawal(input: $input) {
    code
    error
    message
    success
  }
}
```

where

```json
{
  "input": {
    "withdrawalId": "b4f85d5c-652d-472d-873c-4ba2a5e39052",
    "idempotencyKey": "a09b730d-8610-4fda-98fa-ec7acb19c775"
  }
}
```

## TigerBeetle

TigerBeetle is a distributed financial accounting database designed for mission critical safety and performance. Since Rafiki implements the [Interledger Protocol](/reference/glossary#interledger-protocol), which splits payments into packets, we need a high performing and safe database to store all that payment data. For detailed information on TigerBeetle, including its consensus mechanism and its limitations, visit the official TigerBeetle [documentation](https://docs.tigerbeetle.com/) and [blog](https://tigerbeetle.com/blog/).

Rafiki uses a combination of liquidity and settlement accounts to perform double-entry accounting. These accounts correspond to TigerBeetle credit and debit accounts, respectively. For more information on Rafiki's accounting, refer to [Accounts and Transfers](/concepts/accounting/accounts-and-transfers). Note that TigerBeetle only holds balance data and not any other additional metadata included in ILP packets.

### Changing TigerBeetle Version within Rafiki

#### Updating the node client

```sh
# latest
pnpm --filter backend up tigerbeetle-node --latest

# specific version
pnpm --filter backend up tigerbeetle-node@0.15.4
```

#### Production Environment - Helm charts

To use the desired version of TigerBeetle within the production environment, change the tag in the [helm `values.yaml` file](https://github.com/interledger/rafiki/blob/main/infrastructure/helm/tigerbeetle/values.yaml).

#### Local Environment

To use the desired version of TigerBeetle within the local environment, change the tag in the [tigerbeetle `docker-compose.yml` file](https://github.com/interledger/rafiki/blob/main/localenv/tigerbeetle/docker-compose.yml).

#### Tests

To use the desired version of TigerBeetle within the Rafiki tests, change the tag in the [tigerbeetle test setup](https://github.com/interledger/rafiki/blob/main/packages/backend/src/tests/tigerbeetle.ts).
